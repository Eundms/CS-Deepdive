# ë™ê¸°í™” ë„êµ¬ 
## ë®¤í…ìŠ¤
- í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” `ìƒí˜¸ ë°°ì œ(Mutual Exclusion)` ê¸°ë²• 
- ë½ì„ ê±¸ê³  í’€ ìˆ˜ ìˆëŠ” `ê¶Œí•œì´ ê°™ì€ ìŠ¤ë ˆë“œ`ì— ìˆìŒ
- `Lock / UnLock`

```c
#include <stdio.h>
#include <pthread.h>

pthread_mutex_t mutex;

void* thread_function(void* arg) {
    pthread_mutex_lock(&mutex);
    printf("Thread %d in critical section\n", *(int*)arg);
    pthread_mutex_unlock(&mutex);
    return NULL;
}

int main() {
    pthread_t t1, t2;
    int id1 = 1, id2 = 2;

    pthread_mutex_init(&mutex, NULL);
    pthread_create(&t1, NULL, thread_function, &id1);
    pthread_create(&t2, NULL, thread_function, &id2);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    pthread_mutex_destroy(&mutex);

    return 0;
}
```

## ì„¸ë§ˆí¬ì–´
- `ê³µìœ  ìì›ì˜ ê°œìˆ˜ë¥¼ ì œí•œ`í•  ìˆ˜ ìˆëŠ” ë™ê¸°í™” ê¸°ë²•
- ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œê°€ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©°, ì¹´ìš´í„°ë¥¼ í†µí•´ ì œì–´
- `P(Wait) / V(Signal)`

```c
#include <stdio.h>
#include <pthread.h>
#include <semaphore.h>

sem_t semaphore;

void* thread_function(void* arg) {
    sem_wait(&semaphore);
    printf("Thread %d in critical section\n", *(int*)arg);
    sem_post(&semaphore);
    return NULL;
}

int main() {
    pthread_t t1, t2;
    int id1 = 1, id2 = 2;

    sem_init(&semaphore, 0, 2);  // ìµœëŒ€ 2ê°œì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼ ê°€ëŠ¥
    pthread_create(&t1, NULL, thread_function, &id1);
    pthread_create(&t2, NULL, thread_function, &id2);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    sem_destroy(&semaphore);

    return 0;
}
```
## ëª¨ë‹ˆí„°
> ê³µìœ  ìì›ì— ëŒ€í•œ ì ‘ê·¼ì„ ì•ˆì „í•˜ê²Œ ì œì–´í•˜ëŠ” ê³ ìˆ˜ì¤€ì˜ ì¶”ìƒí™”ëœ ë™ê¸°í™” ë„êµ¬
- `ë‚´ë¶€ì ìœ¼ë¡œ ë½ ê´€ë¦¬` 
- `ê°ì²´ ë‹¨ìœ„ë¡œ ë™ê¸°í™”` 
- ì¡°ê±´ ë³€ìˆ˜(Condition Variable) ì‚¬ìš©: wait()ê³¼ signal()ì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤ë ˆë“œ ê°„ì˜ í˜‘ë ¥ì ì¸ ë™ì‘ì„ ì§€ì›í•¨
- Javaì—ì„œ synchronized í‚¤ì›Œë“œë¡œ ì œê³µë¨ 

```java
class MonitorExample {
    private int count = 0;

    public synchronized void increment() {
        count++;
    }

    public synchronized int getCount() {
        return count;
    }
}

public class Main {
    public static void main(String[] args) {
        MonitorExample monitor = new MonitorExample();

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                monitor.increment();
            }
        });

        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                monitor.increment();
            }
        });

        t1.start();
        t2.start();

        try {
            t1.join();
            t2.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("Final count: " + monitor.getCount());
    }
}
```

# ë™ê¸°í™” ì•Œê³ ë¦¬ì¦˜ 
## ë°ì»¤(Dekker) ì•Œê³ ë¦¬ì¦˜ 
> flagì™€ turn ë³€ìˆ˜ë¥¼ í†µí•´ ì„ê³„ êµ¬ì—­ì— ë“¤ì–´ê°ˆ í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œ ê²°ì •
- flag : í”„ë¡œì„¸ìŠ¤ ì¤‘ ëˆ„ê°€ ì„ê³„ì˜ì—­ì— ì§„ì…í•  ê²ƒì¸ì§€ 
- turn : ëˆ„ê°€ ì„ê³„êµ¬ì—­ì— ë“¤ì–´ê°ˆ ì°¨ë¡€ì¸ì§€ 

```java
class Dekker {
    private volatile boolean[] flag = {false, false}; // í”„ë¡œì„¸ìŠ¤ ì¤€ë¹„ ìƒíƒœ
    private volatile int turn = 0; // ëˆ„ê°€ ì‹¤í–‰í•  ì°¨ë¡€ì¸ì§€

    public void criticalSection(int id) {
        int other = 1 - id; // ìƒëŒ€ë°© í”„ë¡œì„¸ìŠ¤ ID

        flag[id] = true; // ìì‹ ì´ ì„ê³„ ì˜ì—­ì— ë“¤ì–´ê°ˆ ì¤€ë¹„ ì™„ë£Œ

        while (flag[other]) { // ìƒëŒ€ë°©ì´ ì„ê³„ ì˜ì—­ì„ ì‚¬ìš© ì¤‘ì´ë©´ ëŒ€ê¸°
            if (turn != id) { 
                flag[id] = false;
                while (turn != id); // ìì‹ ì˜ ì°¨ë¡€ê°€ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                flag[id] = true;
            }
        }

        // ğŸ”´ ì„ê³„ ì˜ì—­ (Critical Section)
        System.out.println("Thread " + id + " is in critical section");

        // ğŸ”µ ì¢…ë£Œ í›„ turn ë³€ê²½
        turn = other;
        flag[id] = false;
    }
}

public class DekkerExample {
    public static void main(String[] args) {
        Dekker dekker = new Dekker();

        Runnable task1 = () -> {
            for (int i = 0; i < 5; i++) dekker.criticalSection(0);
        };

        Runnable task2 = () -> {
            for (int i = 0; i < 5; i++) dekker.criticalSection(1);
        };

        Thread t1 = new Thread(task1);
        Thread t2 = new Thread(task2);

        t1.start();
        t2.start();
    }
}
```

## í”¼í„°ìŠ¨(Peterson) ì•Œê³ ë¦¬ì¦˜
> ë°ì»¤ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ìƒëŒ€ë°© í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œì—ê²Œ ì§„ì… ê¸°íšŒë¥¼ ì–‘ë³´í•˜ëŠ” ê²ƒì— ì°¨ì´ê°€ ìˆìŒ

```java
class Peterson {
    private volatile boolean[] flag = {false, false}; // í”„ë¡œì„¸ìŠ¤ ì¤€ë¹„ ìƒíƒœ
    private volatile int turn = 0; // ëˆ„ê°€ ì‹¤í–‰í•  ì°¨ë¡€ì¸ì§€

    public void criticalSection(int id) {
        int other = 1 - id; // ìƒëŒ€ë°© í”„ë¡œì„¸ìŠ¤ ID

        flag[id] = true; // ìì‹ ì˜ ì§„ì… ì˜ì‚¬ ì„¤ì •
        turn = other; // ìƒëŒ€ë°©ì—ê²Œ ê¸°íšŒ ì–‘ë³´

        while (flag[other] && turn == other) {
            // ëŒ€ê¸° (ìƒëŒ€ë°©ì´ ì„ê³„ ì˜ì—­ì„ ì‚¬ìš© ì¤‘ì´ë©´ ê¸°ë‹¤ë¦¼)
        }

        // ğŸ”´ ì„ê³„ ì˜ì—­
        System.out.println("Thread " + id + " is in critical section");

        flag[id] = false; // ì„ê³„ ì˜ì—­ ì‚¬ìš© ì¢…ë£Œ
    }
}

public class PetersonExample {
    public static void main(String[] args) {
        Peterson peterson = new Peterson();

        Runnable task1 = () -> {
            for (int i = 0; i < 5; i++) peterson.criticalSection(0);
        };

        Runnable task2 = () -> {
            for (int i = 0; i < 5; i++) peterson.criticalSection(1);
        };

        Thread t1 = new Thread(task1);
        Thread t2 = new Thread(task2);

        t1.start();
        t2.start();
    }
}
```

## ì œê³¼ì (Bakery) ì•Œê³ ë¦¬ì¦˜
> ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œì— ëŒ€í•œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•œ ì•Œê³ ë¦¬ì¦˜
> ê°€ì¥ ì‘ì€ ìˆ˜ì˜ ë²ˆí˜¸í‘œë¥¼ ê°€ì§€ê³  ìˆëŠ” í”„ë¡œì„¸ìŠ¤ê°€ ì„ê³„ êµ¬ì—­ì— ì§„ì…

```java
import java.util.Arrays;

class Bakery {
    private volatile boolean[] choosing;
    private volatile int[] ticket;
    private int numThreads;

    public Bakery(int numThreads) {
        this.numThreads = numThreads;
        choosing = new boolean[numThreads];
        ticket = new int[numThreads];
        Arrays.fill(ticket, 0);
    }

    public void lock(int id) {
        choosing[id] = true;

        // ìµœëŒ€ ticket ê°’ì„ ì°¾ì•„ +1 ë¶€ì—¬
        ticket[id] = Arrays.stream(ticket).max().orElse(0) + 1;
        choosing[id] = false;

        for (int i = 0; i < numThreads; i++) {
            if (i == id) continue;

            // ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ticketì„ í• ë‹¹ ì¤‘ì´ë©´ ëŒ€ê¸°
            while (choosing[i]);

            // ìš°ì„ ìˆœìœ„: (1) ticket ê°’ì´ ì‘ì€ í”„ë¡œì„¸ìŠ¤, (2) ticket ê°’ì´ ê°™ìœ¼ë©´ IDê°€ ì‘ì€ í”„ë¡œì„¸ìŠ¤ ìš°ì„ 
            while (ticket[i] != 0 && (ticket[i] < ticket[id] || (ticket[i] == ticket[id] && i < id)));
        }
    }

    public void unlock(int id) {
        ticket[id] = 0; // ì„ê³„ êµ¬ì—­ ì‚¬ìš© ì¢…ë£Œ
    }
}

public class BakeryExample {
    public static void main(String[] args) {
        int numThreads = 3;
        Bakery bakery = new Bakery(numThreads);

        Runnable task = (id -> {
            for (int i = 0; i < 5; i++) {
                bakery.lock(id);
                System.out.println("Thread " + id + " is in critical section");
                bakery.unlock(id);
            }
        });

        Thread[] threads = new Thread[numThreads];
        for (int i = 0; i < numThreads; i++) {
            final int id = i;
            threads[i] = new Thread(() -> task.run(id));
        }

        for (Thread t : threads) t.start();
    }
}
```